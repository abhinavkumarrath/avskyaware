<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>AV SkyAware â€” Viewer</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="icon" href="/avskyawarelogo.jpg" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
<script src="https://openseadragon.github.io/openseadragon/openseadragon.min.js"></script>
<style>
  :root{
    --bg:#040813; --bg2:#091430; --edge:#1A2A52; --edge2:#21406d;
    --brand:#7EC8E3; --accent:#8AF5D4; --accent2:#79D8FF;
    --text:#E9F2FB; --muted:#A5B6CC;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--text);
    font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
    background:
      radial-gradient(1200px 700px at 12% -10%, #0b1b48 0%, transparent 60%),
      linear-gradient(180deg, var(--bg) 0%, var(--bg2) 100%);
    overflow:hidden;
  }

  /* Glow grid background (subtle) */
  .glow-wrap{position:fixed; inset:0; pointer-events:none; z-index:-1}
  .glow{
    position:absolute; inset:-20%;
    background:
      radial-gradient(600px 380px at 18% 18%, rgba(126,200,227,.35), transparent 60%),
      radial-gradient(520px 340px at 80% 12%, rgba(138,245,212,.28), transparent 60%);
    filter:blur(60px); opacity:.55; animation:floatGlow 18s ease-in-out infinite alternate;
  }
  @keyframes floatGlow{to{transform:translateY(-14px) translateX(12px)}}

  /* Header */
  .header{
    position:sticky; top:0; z-index:10;
    display:flex; align-items:center; gap:12px; flex-wrap:wrap;
    padding:10px clamp(12px,3vw,20px);
    background:linear-gradient(180deg, rgba(8,12,28,.62), rgba(5,9,20,.62));
    border-bottom:1px solid var(--edge);
    backdrop-filter: blur(10px);
  }
  .brand{display:flex; align-items:center; gap:12px}
  .brand img{width:36px;height:36px;border-radius:10px;border:1px solid var(--edge);box-shadow:0 0 14px rgba(126,200,227,.35)}
  .brand h1{margin:0;font-family:Orbitron,Inter,sans-serif;color:var(--brand);letter-spacing:.4px;font-size:clamp(18px,3.6vw,24px);text-shadow:0 0 14px rgba(126,200,227,.25)}

  /* Controls */
  .controls{display:flex; gap:10px; align-items:center; margin-left:auto; flex-wrap:wrap}
  .chip, select, .btn{
    border-radius:12px; border:1px solid var(--edge);
    background:linear-gradient(180deg,#0A162E,#0A1326);
    color:var(--text); padding:10px 12px; font-size:14px;
    transition: border-color .2s ease, box-shadow .2s ease, transform .15s ease;
  }
  .chip{color:#BFE9FF}
  select:focus{outline:none; border-color:var(--edge2); box-shadow:0 0 0 3px rgba(126,200,227,.15)}
  .btn{
    background:linear-gradient(135deg, var(--accent2), var(--accent));
    color:#031018; font-weight:700; cursor:pointer; box-shadow:0 10px 28px rgba(143,244,212,.22);
  }
  .btn:hover{ transform:translateY(-1.5px); box-shadow:0 16px 34px rgba(143,244,212,.3)}
  .ghost{ background:transparent; color:#BFE9FF; border-color:var(--edge) }

  /* Status + progress */
  .status{color:var(--muted); min-width:110px; text-align:right}
  .bar{position:relative; height:3px; width:120px; border-radius:999px; overflow:hidden; background:#0b1933; border:1px solid #102347}
  .bar > i{display:block; height:100%; width:0; background:linear-gradient(90deg,#79D8FF,#8AF5D4); animation:load 1.2s ease infinite}
  @keyframes load{0%{width:0} 50%{width:80%} 100%{width:0}}

  /* Stage */
  .stage{height:calc(100vh - 68px); padding:10px}
  .frame{
    position:relative; height:100%; border-radius:16px; border:1px solid var(--edge);
    background: radial-gradient(1000px 600px at 0% -20%, rgba(120,160,255,.06), transparent 50%), #061026;
    box-shadow: 0 18px 50px rgba(0,0,0,.45), inset 0 0 60px rgba(126,200,227,.08);
    overflow:hidden;
  }
  .vignette:after{
    content:""; position:absolute; inset:0; pointer-events:none;
    background: radial-gradient(120% 100% at 50% 50%, transparent 50%, rgba(0,0,0,.22) 100%);
  }

  /* OSD container */
  #viewer{
    position:absolute; inset:0;
    opacity:0; transform:translateY(6px); transition:opacity .6s ease, transform .6s ease;
  }
  #viewer.visible{opacity:1; transform:none}

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce){
    #viewer{transition:none}
    .glow{animation:none}
  }
</style>
</head>
<body>
<div class="glow-wrap"><div class="glow"></div></div>

<header class="header">
  <div class="brand">
    <img src="/avskyawarelogo.jpg" alt="AV SkyAware logo" />
    <h1>AV SkyAware Viewer</h1>
  </div>
  <div class="controls">
    <span class="chip">Deep Zoom</span>
    <select id="imageSelect" aria-label="Select TIFF">
      <option value="">Select TIFF</option>
    </select>
    <button id="openBtn" class="btn">Open</button>
    <a class="btn ghost" href="/">Home</a>
    <span id="message" class="status">Ready</span>
    <span id="progress" class="bar" style="display:none"><i></i></span>
  </div>
</header>

<main class="stage">
  <div class="frame vignette">
    <div id="viewer"></div>
  </div>
</main>

<script>
  let viewer = null;
  const select = document.getElementById('imageSelect');
  const openBtn = document.getElementById('openBtn');
  const message = document.getElementById('message');
  const prog = document.getElementById('progress');
  const viewerEl = document.getElementById('viewer');

  function setStatus(text){ message.textContent = text; }
  function showViewer(){ viewerEl.classList.add('visible'); }
  function hideViewer(){ viewerEl.classList.remove('visible'); }
  function showProgress(show){
    prog.style.display = show ? 'inline-block' : 'none';
  }

  async function loadImages(){
    try{
      const res = await fetch('/api/images');
      const data = await res.json();
      data.images.forEach(name=>{
        const opt = document.createElement('option');
        opt.value = name; opt.textContent = name;
        select.appendChild(opt);
      });
    }catch(e){
      setStatus('Failed to load images');
    }
  }

  function bootViewer(dziUrl){
    if (viewer) viewer.destroy();
    viewer = OpenSeadragon({
      id: 'viewer',
      prefixUrl: "https://openseadragon.github.io/openseadragon/images/",
      tileSources: dziUrl,
      showNavigator: true,
      imageSmoothingEnabled: true,
      immediateRender: true,
      blendTime: 0.05,
      animationTime: 0.9,
      minZoomImageRatio: 0.7,
      maxZoomPixelRatio: 1.3
    });
    hideViewer();
    requestAnimationFrame(()=> setTimeout(showViewer, 60));
  }

  async function openSelected(){
    const name = select.value;
    if (!name){
      if (viewer) viewer.destroy();
      hideViewer();
      setStatus('Ready');
      showProgress(false);
      return;
    }
    hideViewer();
    setStatus('Converting and loading...');
    showProgress(true);
    try{
      const res = await fetch('/api/convert', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ name })
      });
      if (!res.ok){
        const t = await res.text();
        throw new Error(t || 'Convert failed');
      }
      const data = await res.json();
      bootViewer(data.dziUrl);
      setStatus('Loaded');
    }catch(e){
      setStatus('Error: '+e.message);
    }finally{
      showProgress(false);
    }
  }

  openBtn.addEventListener('click', openSelected);
  select.addEventListener('keydown', (e)=>{ if (e.key==='Enter') openSelected(); });

  // Desktop shortcuts
  document.addEventListener('keydown', (e)=>{
    if (e.key === 'o' || e.key === 'O') openSelected();
    if (e.key === 'h' || e.key === 'H') location.href = '/';
    if (!viewer) return;
    if (e.key === 'r' || e.key === 'R') viewer.viewport.goHome(true);
    if (e.key === '1') viewer.viewport.zoomBy(0.9).applyConstraints();
    if (e.key === '2') viewer.viewport.zoomBy(1.1).applyConstraints();
  });

  loadImages();
</script>
</body>
</html>
